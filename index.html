<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Background Audio + Repeat (PWA)</title>
  <meta name="theme-color" content="#000000"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    *{box-sizing:border-box} :root{--bg:#000;--fg:#eaeaea;--muted:#9aa0a6;--accent:#e11d48;}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #111;position:sticky;top:0;background:#000}
    h1{margin:0;font-size:18px} .ghost{background:transparent;border:1px solid #333;color:#ddd;padding:8px 12px;border-radius:10px;cursor:pointer}
    main{max-width:900px;margin:0 auto;padding:20px}
    .uploader{border:1px dashed #2a2a2a;border-radius:16px;padding:18px;margin-bottom:18px;text-align:center;background:#0b0b0b}
    .drop{display:block;padding:28px;border-radius:12px;background:#0f0f0f;cursor:pointer}
    .drop strong{display:block;font-size:18px;margin-bottom:6px} .drop span{color:var(--muted)}
    .uploader input[type=file]{display:none} .hint{color:var(--muted);font-size:12px;margin-top:8px}
    .player{border:1px solid #111;border-radius:16px;background:#0b0b0b;padding:16px} .meta{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .thumb{width:44px;height:44px;display:grid;place-items:center;background:#0e0e0e;border:1px solid #181818;border-radius:10px} .title{font-weight:600}
    .transport{display:grid;gap:8px;margin:12px 0} .primary{appearance:none;background:var(--accent);color:white;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    #seek{width:100%} .time{color:var(--muted);font-size:12px;display:flex;gap:6px;justify-content:flex-end}
    .row{display:flex;gap:8px;align-items:center} .toggle{border:1px solid #333;background:#121212;color:#ddd;border-radius:10px;padding:10px 12px;cursor:pointer}
    .toggle.active{border-color:#0c3b12;background:#071708} .note{color:var(--muted);font-size:12px;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <header class="topbar">
    <h1>Audio (BG + Repeat)</h1>
    <button id="installBtn" class="ghost" hidden>ØªØ«Ø¨ÙŠØª</button>
  </header>
  <main>
    <section class="uploader" id="dropZone">
      <input type="file" id="fileInput" accept="video/*,audio/*"/>
      <label for="fileInput" class="drop"><strong>Ø§Ø±ÙØ¹ ÙÙŠØ¯ÙŠÙˆ / ØµÙˆØª</strong><span>Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</span></label>
      <p class="hint">ÙŠØ´ØºÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆÙŠØ¸Ù‡Ø± ØªØ­ÙƒÙ… Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„. Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…ÙØ¹Ù‘Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§.</p>
    </section>

    <section class="player" hidden>
      <div class="meta"><div class="thumb">ğŸ§</div><div class="title" id="title">â€”</div></div>
      <div class="transport">
        <div class="row">
          <button id="playPause" class="primary">ØªØ´ØºÙŠÙ„</button>
          <button id="loopBtn" class="toggle">ØªÙƒØ±Ø§Ø± â™¾ï¸</button>
        </div>
        <input type="range" id="seek" min="0" max="1" step="0.001" value="0">
        <div class="time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
      </div>
      <p class="note">Ø¨Ø¯ÙˆÙ† Ø³Ø±Ø¹Ø©/Ø¨ÙŠØªØ´ â€” ÙÙ‚Ø· ØªØ´ØºÙŠÙ„ Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© + ØªÙƒØ±Ø§Ø±.</p>
    </section>
  </main>

  <audio id="player" preload="metadata" playsinline style="display:none" crossorigin="anonymous"></audio>

  <script>
  // Register SW for installability + offline
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
  // PWA install prompt (Android/Chrome)
  const installBtn = document.getElementById('installBtn');
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.hidden=false; });
  installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.hidden=true; });
  window.addEventListener('appinstalled', ()=>{ installBtn.hidden=true; });

  const input = document.getElementById('fileInput');
  const drop = document.getElementById('dropZone');
  const section = document.querySelector('.player');
  const titleEl = document.getElementById('title');
  const seek = document.getElementById('seek');
  const cur = document.getElementById('cur'); const dur = document.getElementById('dur');
  const audio = document.getElementById('player');
  const playPauseBtn = document.getElementById('playPause');
  const loopBtn = document.getElementById('loopBtn');

  let url = null, userPaused = false;

  function stamp(s){ if(!isFinite(s)) return '0:00'; const m=Math.floor(s/60),r=Math.floor(s%60); return `${m}:${String(r).padStart(2,'0')}`; }

  audio.loop = true; loopBtn.classList.add('active'); loopBtn.textContent='ØªÙƒØ±Ø§Ø± â™¾ï¸ (Ù…ÙØ¹Ù‘Ù„)';
  loopBtn.onclick = () => { audio.loop = !audio.loop; loopBtn.classList.toggle('active', audio.loop); loopBtn.textContent = audio.loop ? 'ØªÙƒØ±Ø§Ø± â™¾ï¸ (Ù…ÙØ¹Ù‘Ù„)' : 'ØªÙƒØ±Ø§Ø± â™¾ï¸ (Ù…ÙˆÙ‚Ù‘Ù)'; };

  ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
  drop.addEventListener('drop', e=>{ const f=e.dataTransfer?.files?.[0]; if(f) loadFile(f); });
  input.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) loadFile(f); });

  async function loadFile(file){
    if(url) URL.revokeObjectURL(url);
    url = URL.createObjectURL(file);
    audio.pause(); userPaused = false;
    audio.src = url; audio.load();
    titleEl.textContent = file.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
    section.hidden = false;

    if('mediaSession' in navigator){
      navigator.mediaSession.metadata = new MediaMetadata({
        title: titleEl.textContent, artist: 'Local file', album: 'Background Audio',
        artwork: [
          {src:'icon-192.png',sizes:'192x192',type:'image/png'},
          {src:'icon-512.png',sizes:'512x512',type:'image/png'}
        ]
      });
      navigator.mediaSession.setActionHandler('play', () => audio.play());
      navigator.mediaSession.setActionHandler('pause', () => audio.pause());
      navigator.mediaSession.playbackState = 'playing';
    }

    await audio.play().catch(()=>{});
    playPauseBtn.textContent='Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
  }

  playPauseBtn.onclick = () => {
    if(audio.paused){ userPaused=false; audio.play().catch(()=>{}); playPauseBtn.textContent='Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª'; }
    else { userPaused=true; audio.pause(); playPauseBtn.textContent='ØªØ´ØºÙŠÙ„'; }
  };

  audio.addEventListener('loadedmetadata', () => { seek.max = audio.duration || 1; dur.textContent = stamp(audio.duration); cur.textContent = '0:00'; });
  audio.addEventListener('timeupdate', () => { if(!seek.matches(':active')) seek.value = audio.currentTime; cur.textContent = stamp(audio.currentTime); });
  seek.addEventListener('input', () => { audio.currentTime = Number(seek.value); });

  // Try to auto-resume if background pause happened unexpectedly
  document.addEventListener('visibilitychange', () => { if(document.visibilityState!=='visible' && audio.src && audio.paused && !userPaused) audio.play().catch(()=>{}); });
  </script>
</body>
</html>
