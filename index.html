<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Background Audio + Repeat</title>
  <meta name="theme-color" content="#000000"/>
  <style>
    *{box-sizing:border-box} :root{--bg:#000;--fg:#eaeaea;--muted:#9aa0a6;--accent:#e11d48;}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #111;position:sticky;top:0;background:#000}
    h1{margin:0;font-size:18px} .ghost{background:transparent;border:1px solid #333;color:#ddd;padding:8px 12px;border-radius:10px;cursor:pointer}
    main{max-width:900px;margin:0 auto;padding:20px}
    .uploader{border:1px dashed #2a2a2a;border-radius:16px;padding:18px;margin-bottom:18px;text-align:center;background:#0b0b0b}
    .drop{display:block;padding:28px;border-radius:12px;background:#0f0f0f;cursor:pointer}
    .drop strong{display:block;font-size:18px;margin-bottom:6px} .drop span{color:var(--muted)}
    .uploader input[type=file]{display:none} .hint{color:var(--muted);font-size:12px;margin-top:8px}
    .player{border:1px solid #111;border-radius:16px;background:#0b0b0b;padding:16px} .meta{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .thumb{width:44px;height:44px;display:grid;place-items:center;background:#0e0e0e;border:1px solid #181818;border-radius:10px} .title{font-weight:600}
    .transport{display:grid;gap:8px;margin:12px 0} .primary{appearance:none;background:var(--accent);color:white;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    #seek{width:100%} .time{color:var(--muted);font-size:12px;display:flex;gap:6px;justify-content:flex-end}
    .row{display:flex;gap:8px;align-items:center} .toggle{border:1px solid #333;background:#121212;color:#ddd;border-radius:10px;padding:10px 12px;cursor:pointer}
    .toggle.active{border-color:#0c3b12;background:#071708} .note{color:var(--muted);font-size:12px;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <header class="topbar"><h1>Audio (BG + Repeat)</h1><button id="installBtn" class="ghost" hidden>تثبيت</button></header>
  <main>
    <section class="uploader" id="dropZone">
      <input type="file" id="fileInput" accept="video/*,audio/*"/>
      <label for="fileInput" class="drop"><strong>ارفع فيديو / صوت</strong><span>اسحب الملف هنا أو اضغط للاختيار</span></label>
      <p class="hint">يشغل الصوت بالخلفية ويظهر تحكم شاشة القفل. التكرار مفعّل افتراضيًا.</p>
    </section>

    <section class="player" hidden>
      <div class="meta"><div class="thumb">🎧</div><div class="title" id="title">—</div></div>
      <div class="transport">
        <div class="row">
          <button id="playPause" class="primary">تشغيل</button>
          <button id="loopBtn" class="toggle">تكرار ♾️</button>
        </div>
        <input type="range" id="seek" min="0" max="1" step="0.001" value="0">
        <div class="time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
      </div>
      <p class="note">لن نبدّل السرعة/الطبقة — فقط تشغيل بالخلفية مع تكرار.</p>
    </section>
  </main>

  <audio id="player" preload="metadata" playsinline style="display:none" crossorigin="anonymous"></audio>

  <script>
  if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(l => l.forEach(r => r.unregister())); }

  const input = document.getElementById('fileInput');
  const drop = document.getElementById('dropZone');
  const section = document.querySelector('.player');
  const titleEl = document.getElementById('title');
  const seek = document.getElementById('seek');
  const cur = document.getElementById('cur'); const dur = document.getElementById('dur');
  const audio = document.getElementById('player');
  const playPauseBtn = document.getElementById('playPause');
  const loopBtn = document.getElementById('loopBtn');

  let url = null, userPaused = false;

  function stamp(s){ if(!isFinite(s)) return '0:00'; const m=Math.floor(s/60),r=Math.floor(s%60); return `${m}:${String(r).padStart(2,'0')}`; }

  audio.loop = true; loopBtn.classList.add('active'); loopBtn.textContent='تكرار ♾️ (مفعّل)';
  loopBtn.onclick = () => { audio.loop = !audio.loop; loopBtn.classList.toggle('active', audio.loop); loopBtn.textContent = audio.loop ? 'تكرار ♾️ (مفعّل)' : 'تكرار ♾️ (موقّف)'; };

  ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
  drop.addEventListener('drop', e=>{ const f=e.dataTransfer?.files?.[0]; if(f) loadFile(f); });
  input.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) loadFile(f); });

  async function loadFile(file){
    if(url) URL.revokeObjectURL(url);
    url = URL.createObjectURL(file);
    audio.pause(); userPaused = false;
    audio.src = url; audio.load();
    titleEl.textContent = file.name || 'بدون اسم';
    section.hidden = false;

    if('mediaSession' in navigator){
      navigator.mediaSession.metadata = new MediaMetadata({
        title: titleEl.textContent, artist: 'Local file', album: 'Background Audio',
        artwork: [{src: 'data:image/png;base64,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', sizes:'192x192', type:'image/png'}]
      });
      navigator.mediaSession.setActionHandler('play', () => audio.play());
      navigator.mediaSession.setActionHandler('pause', () => audio.pause());
      navigator.mediaSession.playbackState = 'playing';
    }

    await audio.play().catch(()=>{});
    playPauseBtn.textContent='إيقاف مؤقت';
  }

  playPauseBtn.onclick = () => {
    if(audio.paused){ userPaused=false; audio.play().catch(()=>{}); playPauseBtn.textContent='إيقاف مؤقت'; }
    else { userPaused=true; audio.pause(); playPauseBtn.textContent='تشغيل'; }
  };

  audio.addEventListener('loadedmetadata', () => { seek.max = audio.duration || 1; dur.textContent = stamp(audio.duration); cur.textContent = '0:00'; });
  audio.addEventListener('timeupdate', () => { if(!seek.matches(':active')) seek.value = audio.currentTime; cur.textContent = stamp(audio.currentTime); });
  seek.addEventListener('input', () => { audio.currentTime = Number(seek.value); });

  // محاولة إعادة التشغيل لو سكت بالغلط بالخلفية
  document.addEventListener('visibilitychange', () => { if(document.visibilityState!=='visible' && audio.src && audio.paused && !userPaused) audio.play().catch(()=>{}); });
  </script>
</body>
</html>
